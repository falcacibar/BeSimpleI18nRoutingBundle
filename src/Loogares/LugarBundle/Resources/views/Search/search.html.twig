{% extends "::base.html.twig" %}

{% block title %}{{'lugar.buscar.titulo'|trans({'%buscar%' : buscar})}} | {{parent()}}{% endblock %}

{% block javascripts %}
	<script src="{{asset('assets/js/jquery.raty.min.js')}}"></script>
	<script>
		$(document).ready(function(){
			$('.resultado-busqueda-stars-raty').each(function(){
				var estrellas = $(this).attr('data-stars');
				$(this).raty({
					width: 140,
				    starOff:  WEBROOT+'../assets/images/extras/estrella_vacia_recomendacion.png',
				    starOn:   WEBROOT+'../assets/images/extras/estrella_llena_recomendacion.png',
				    starHalf:   WEBROOT+'../assets/images/extras/estrella_media_recomendacion.png',
				    half: true,
				    start: estrellas,
				    readOnly: true,
				    space: false
				});
			});

			$('.resultado-busqueda-precio-raty').each(function(){
				var precio = $(this).attr('data-precio');
				$(this).raty({
					width: 140,
			        starOff:  WEBROOT+'../assets/images/extras/precio_vacio.png',
			        starOn:   WEBROOT+'../assets/images/extras/precio_lleno.png',
				    half: true,
				    start: precio,
				    readOnly: true,
				    space: false
				});
			});



			$('.ver_categorias').live('click', function(){
				var $div = $( ".expandir_resultados" ),
					alto = $div.height();
					
				if(alto == 100){
					var startHeight = $div.height();
					$div.css( "height", "auto" );
					var endHeight = $div.height();
					$div.height( startHeight ).animate({ 
						height: endHeight 
					}, 500);
				}else{
					$div.animate({
						'height': 100
					}, 500);	
				}
			});

			$('.ver_zonas').live('click', function(){
				var $div = $('.expandir_zonas'),
					alto = $div.height();

				if(alto == 7){
					var startHeight = $div.height();
					$div.css( "height", "auto" );
					var endHeight = $div.height();
					$div.height( startHeight ).animate({ 
						height: endHeight,
						width: 940
					}, 500);
				}else{
					$div.animate({
						'width': 145,
						'height': 7
					});					
				}
			});

			$('.expandir_resultados a, .expandir_zonas a').live('click', function(e){
				var $this = $(this),
					data = {};

				data[$this.attr('rel')] = $this.attr('data-slug');

				$('.resultados-wrapper').html('').append("<div id='overlay'/>");
				
				$('.resultados-wrapper').append("<img class='loader' src='"+WEBROOT+"../assets/images/extras/loader.gif'>");
				
				$('.resultados-wrapper').load(window.location.href + " .resultados", data, function(data){
					$('#overlay, .loader').fadeOut(function(){$this.remove()});
					console.log(data)
				});
				return false;
			});


		});
	</script>
{% endblock %}

{% block content %}
<style>

	.filtros-busqueda li{
		display: inline;
	}

	.expandir_zonas{
		display: inline-block;
		font-size: 12px;
		background: #fafafa;
		border: 1px #eee solid;
		padding: 10px;
		position: relative;
		overflow: hidden;
		width: 145px;
		height: 7px;
	}

		.expandir_zonas span{
			display: inline-block;
			cursor: pointer;
		}

	.expandir_resultados{
		display: inline-block;
		font-size: 12px;
		background: #fafafa;
		border: 1px #eee solid;
		padding: 10px;
		position: relative;
		width: 940px;
		height: 100px;
		overflow: hidden;
	}
		.expandir_resultados span{
			display: inline-block;
			cursor: pointer;
		}

		.expandir_resultados .ver_categorias{
			float: right;
		}

		.expandir_resultados ul, .expandir_zonas ul{
			width: 940px;
		}

			.expandir_resultados ul li, .expandir_zonas ul li{
				display: inline-block;
				width: 232px;
				margin: 10px 0;
				font-size: 12px !important;
			}
</style>
	<div class="resultados-wrapper">
		<div class="resultados">
			<h1 class="titulo">Resultados de Busqueda en {{slug}}</h1>
			{% if results.totalPorCategoria is defined or results.totalPorSubcategoria is defined %}
			<div class="expandir_resultados">
				<span>Resultados por categoria</span>
				<span class="ver_categorias">Ver Todas ></span>
				<div class="resultados_busqueda">
					{% if es == 'busqueda' %}
					<div class="resultados_categorias">
						<ul>
							{% for categoria in results.totalPorCategoria %}
								<li><a rel="categoria" data-slug="{{categoria.slug}}" class="link_azul" href="">{{categoria.nombre}} ({{ categoria.total }})</a></li>
							{% endfor %}
						</ul>
					</div>
					{% endif %}
					{% if es == 'categoria' %}
					<div class="resultados_subcategorias">
						<strong>Subcategorías</strong>
						<ul>
							{% for subcategoria in results.totalPorSubcategoria %}
								<li><a rel="subcategoria" data-slug="{{subcategoria.slug}}" class="link_azul" href="">{{subcategoria.nombre}} ({{ subcategoria.total }})</a></li>								
							{% endfor %}
						</ul>
					</div>
					{% endif %}
				</div>
			</div>
			{% endif %}
			{% if results.totalPorSectores is defined or results.totalPorComunas is defined %}
			<div class="expandir_zonas">
				<span class="ver_zonas">Ver resultados por zonas ></span>
				{% if results.totalPorSectores is defined %}
				<div class="resultados_sectores">
					<strong>Sectores</strong>
					<ul>
						{% for sector in results.totalPorSectores %}
							<li><a rel="sector" class="link_azul" data-slug="{{sector.slug}}" href="">{{sector.nombre}} ({{sector.total }})</a></li>
						{% endfor %}
					</ul>
				</div>
				{% endif %}
				{% if results.totalPorComunas is defined %}
				<div class="resultados_comunas">
					<strong>Comunas</strong>
					<ul>
						{% for comuna in results.totalPorComunas %}
							<li><a rel="comuna" class="link_azul" href="#" data-slug="{{comuna.slug}}">{{comuna.nombre}} ({{comuna.total }})</a></li>
						{% endfor %}
					</ul>
				</div>
				{% endif %}
			</div>
			{% endif %}
			{% if lugares|length == 0 %}
				No hay resultados, :()
			{% else %}
				<br/>

				<div class="total_paginacion">
				    <strong>
				        {{paginacion.mostrandoDe}}</strong> al <strong>{{paginacion.mostrandoHasta}}</strong> de <strong>{{paginacion.total}}
				    </strong>
				</div>

				<ul class="paginacion">
				    {{paginacion.paginacion | raw}}
				</ul>

			    <ul class="filtros-busqueda">
			        <li>
			            <strong>{{'general.terminos.ordenar_por'|trans}}: </strong>
			        </li>
			        <li>
			            {% if query.orden is not defined or query.orden == 'relevantes' %}
			                <strong>{{'general.terminos.mas_relevantes'|transchoice(2)}}</strong>
			            {% else %}
			                <a class="link_azul" href="{{ path("_buscar", {'slug': slug,'buscar': buscar, 'orden': 'relevantes' }) }}">{{'general.terminos.mas_relevantes'|transchoice(2)}}</a>
			            {% endif %}	
			        </li>
			        <li>|</li>
			        <li>
			            {% if query.orden is defined and query.orden == 'recomendaciones' %}
			                <strong>{{'general.terminos.mejor_recomendaciones'|transchoice(2)}}</strong>
			            {% else %}
			                <a class="link_azul" href="{{ path("_buscar", {'slug': slug,'buscar': buscar, 'orden': 'recomendaciones' }) }}">{{'general.terminos.mejor_recomendaciones'|transchoice(2)}}</a>
			            {% endif %}
			        </li>
			        <li>|</li>
			        <li>
			            {% if query.orden is defined and query.orden == 'utiles' %}
			                <strong>{{'general.terminos.mas_utiles'|transchoice(2)}}</strong>
			            {% else %}
			                <a class="link_azul" href="{{ path("_buscar", {'slug': slug,'buscar': buscar, 'orden': 'utiles' }) }}">{{'general.terminos.mas_utiles'|transchoice(2)}}</a>
			            {% endif %}
			        </li>
			        <li>|</li>
			        <li>
			            {% if query.orden is defined and query.orden == 'ultima-recomendacion' %}
			                <strong>{{'general.terminos.ultima_recomendacion'|trans}}</strong>
			            {% else %}
			                <a class="link_azul" href="{{ path("_buscar", {'slug': slug,'buscar': buscar, 'orden': 'ultima-recomendacion' }) }}">{{'general.terminos.ultima_recomendacion'|transchoice(1)}}</a>
			            {% endif %}
			        </li>
			        <li>|</li>
			        <li>
			            {% if query.orden is defined and query.orden == 'alfabetico' %}
			                <strong>{{'general.terminos.alfabetico'|trans}}</strong>
			            {% else %}
			                <a class="link_azul" href="{{ path("_buscar", {'slug': slug, 'buscar': buscar, 'orden': 'alfabetico' }) }}">{{'general.terminos.alfabetico'|trans}}</a>
			            {% endif %}
			        </li>
			    </ul>

			    <div class="resultados_por_pagina">
			        <select class="seleccionar_resultados_por_pagina">
			            <option value="30">30</option>
			            <option value="45">45</option>
			            <option value="60">60</option>
			        </select>
			        <p class="resultados_por_pagina_txt">{{'general.terminos.resultados'|trans}}</p>
			    </div>
		  <br/><br/><br/><br/><br/><br/>
		  {% endif %}
			{% for lugar in lugares %}
				<div class="resultado-busqueda">
					<div class="datos-principales">
						<ul>
							<li>
								<div class="indice-resultado">{{loop.index}}</div>
								<img src="{{ ('assets/images/lugares/'~lugar.imagen_lugar) | apply_filter('small_lugar')}}" />
								<a href="{{ path('_lugar', {'slug': lugar.slug}) }}">{{lugar.nombre}}</a>
							</li>
							{% if lugar.categorias_nombre != '' %}
							<li>
								<span><strong>{{'general.terminos.categorias'|transchoice(lugar.categorias_nombre)}}</strong></span>
								{% for categoria in lugar.categorias_nombre %}
									{{categoria|raw}}{% if loop.last == null %}, {% endif %}
								{% endfor %}
							</li>
							{% endif %}
							{% if lugar.sector_nombre != '' %}
							<li>
								<span><strong>{{'general.terminos.sector'|trans}}</strong></span>
								<a href="{{lugar.sector_slug}}">{{lugar.sector_nombre}}</a>
							</li>
							{% endif %}
							{% if lugar.ultima_recomendacion != '' %}
							<li>
								<span><strong>
								    <img src="{{ ('assets/images/usuarios/'~lugar.usuario_imagen) | apply_filter('tiny_usuario')}}" />
									{{lugar.fecha_ultima_recomendacion|date('y/m/d') }}
									{% if lugar.usuario_nombre != '' %}
										<a href="{{ path('showUsuario', {'param': lugar.usuario_slug}) }}">{{lugar.usuario_nombre}} {{lugar.usuario_apellido}}</a>
									{% else %}
										<a href="{{ path('showUsuario', {'param': lugar.usuario_slug}) }}">{{lugar.usuario_slug}}</a>
									{% endif %}
								</strong></span>
								<p>{{lugar.ultima_recomendacion}}...</p>
							</li>
							{% endif %}
						</ul>
					</div>
					<div class="datos-secundarios">
						<ul>
							<li><div data-stars="{{lugar.estrellas}}" class="resultado-busqueda-stars-raty"></div></li>
							<li>{{lugar.total_recomendaciones | default(0)}} {{'lugar.buscar.total_recomendaciones'|transchoice(lugar.total_recomendaciones)}}</li>
							{% if lugar.precio != null %}
								<div data-precio="{{lugar.precio}}" class="resultado-busqueda-precio-raty"></div>
							{% endif %}
							<li>{{lugar.calle}} {{lugar.numero}} - <a href="{{lugar.comuna_slug}}">{{lugar.comuna_nombre}}</a></li>
							<li>Ranking: {{lugar.ranking}}</li>
						</ul>
					</div>
				</div>
			{% endfor %}
		</div>
		<div id="agrega-lugar"><p>¿No encontraste el Lugar que buscabas?
¡Entonces agrégalo y sé el primero en recomendarlo!</p><a href="{{ path('_agregar') }}">Boton</a></div>
	</div>
{% endblock %}