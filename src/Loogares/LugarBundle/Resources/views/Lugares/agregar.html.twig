{% extends "::base.html.twig" %}

{% block title %}Agregar Lugar | {{parent()}}{% endblock %}

{% block stylesheets %}
    <style>
    </style>
{% endblock %}

{% block javascripts %}
    <script src="../../assets/js/masterObject.js"></script>
    <script>
        String.prototype.camelCase = function() {
            str = this;
            return str
                .replace(/[\s\-](.)/g, function($1) { return $1.toUpperCase(); })
                .replace(/[\s\-]/g, '')
                .replace(/^(.)/, function($1) { return $1.toLowerCase(); });
        }

        function actualizarComunas(){
            var ciudadSeleccionada = $('.ciudad > option:selected').text();
            $.each(optGroupComunas, function(i){
                if(optGroupComunas[i].match(ciudadSeleccionada)){
                    $('.comuna > optgroup').remove('optgroup');
                    $('.comuna').append(optGroupComunas[i]);
                }
            });

            $.each(optGroupSectores, function(i){
                if(optGroupSectores[i].match(ciudadSeleccionada)){
                    $('.sector > optgroup').remove('optgroup');
                    $('.sector').append(optGroupSectores[i]);
                }
            });
        }

        /* INITIALIZATION */

        var optGroupComunas = [],
            optGroupSectores = [],
            selected = {},
            caracteristicasASacar = [];

        $('input[type=text], textarea').each(function(){ $(this).placeholder() });

        $('.comuna > optgroup').each(function(i){
            optGroupComunas[i] = $(this).outerHTML();
            $(this).remove();
        });

        $('.sector > optgroup').each(function(i){
            optGroupSectores[i] = $(this).outerHTML();
            $(this).remove();
        });

        actualizarComunas();

        $('.quitar').click(function(e){
            e.preventDefault();

            var $this = $(this);
                rel = $this.attr('rel') || '',
                count = 0;

            $this.parent().parent().fadeOut();
            $this.parent().parent().prev('li').find('span').fadeIn();

            if(rel.indexOf(['categoria', 'telefono'])){
                count = parseInt($('a.display-more-info[rel="'+rel+'"]').find('span').text());

                if(count == 0){
                    $('a.display-more-info[rel="'+rel+'"]').parent().parent().fadeIn().css('display', 'block');
                }

                $('a[rel='+rel+']').find('span').text(count + 1)
            }
        });

        $('.display-next-li').click(function(e){
            e.preventDefault(); 
            $(this).parent().parent().next('li').fadeIn().css('display', 'block');
            $(this).parent().fadeOut();
        });

        $('.display-more-info').click(function(e){
            e.preventDefault();
            
            var $this = $(this),
                rel = $this.attr('rel');
                count = parseInt($this.find('span').text()) - 1;
                if(count == 0){
                    $this.parent().parent().fadeOut();
                }

                if(count >= 0){
                    $('.'+rel+':not(:hidden):last').parent().next('li').fadeIn().css('display', 'block');
                    $this.find('span').text(count);
                }
        });


        $('.categoria').live('change', function(){
            $this = $(this);
            var categoria = $(this).val().camelCase(),
                anterior = selected[$this.attr('id')];

            //Deshabilitar en los demas dropdown
            $('.categoria').not($this).each(function(){
                //Deshabilitamos en el resto de los dropdowns el valor que seleccionamos recien
                $(this).find('option[value="'+$this.val()+'"]').attr('disabled', 'disabled').addClass(categoria);
                
                //Habilitamos el valor anterior
                $(this).find('option[value="'+selected[$this.attr('id')]+'"]').removeAttr('disabled');
            });

            $('.caracteristica').fadeOut().parent().remove();

            $('.categoria').not(':hidden').each(function(){
                thisCat = $(this).val().camelCase();
                caracteristicas = categorias[thisCat].caracteristicas;
                if(caracteristicas != ''){ 
                    $('.caracteristicas').parent().fadeIn().css('display', 'block');
                }else{
                    $('.caracteristicas').parent().fadeOut();
                }
                $.each(caracteristicas, function(i){
                    if($('input[value="'+caracteristicas[i]+'"]').val() != caracteristicas[i]){
                        checkBoxHTML = "<li>"+
                                           "<label class='checkbox-label caracteristica'>"+
                                           "<input type='checkbox'"+
                                           " class='"+categoria+"'"+
                                           " name=caracteristica[]"+
                                           " value='"+caracteristicas[i]+"'/>"+
                                           "<span>"+caracteristicas[i]+"</span></label>"+
                                       "</li>";
                        
                        $('.caracteristicas ul').append(checkBoxHTML);
                        $('.caracteristicas').parent().fadeIn();
                    }
                });
                if( anterior != undefined ){
                    //Por cada categoria que deshabilitamos
                    habilitar = categorias[anterior.camelCase()].deshabilitar;
                    $.each(habilitar, function(i){
                        $('.categoria').not($this).each(function(){
                            $aHabilitar = $(this).find('option[value="'+habilitar[i]+'"]');
                            //Por cada categoria, reviamos si otra Categoria la deshabilito, comprobamos si la clase que la deshabilito
                            //Es la ultima, si es, la habilitamos, si no, permanece deshabilitado
                            
                            if($aHabilitar.checkDefaultClass(anterior)){
                                //Enable it
                               $aHabilitar.removeAttr('disabled');
                            }
                        });
                    }); //End Habilitar

                    //Sacamos los camposo especiales.
                    camposEspeciales = categorias[anterior.camelCase()].camposEspeciales
                    $.each(camposEspeciales, function(i){
                        $('#form_'+camposEspeciales[i]).parent().fadeOut().css('display', 'block');
                    });

                    //Subcategorias
                    $this.parent().find('.subcategorias ul').html('');
                }
            });// end each

            camposEspeciales = categorias[categoria].camposEspeciales
            $.each(camposEspeciales, function(i){
                $('#form_'+camposEspeciales[i]).parent().fadeIn().css('display', 'block');
            });

            subCategorias = categorias[categoria].subCategorias;
            $.each(subCategorias, function(i){
                checkBoxHTML = "<li>"+
                                   "<label class='checkbox-label subcategoria'>"+
                                   "<input type='checkbox' "+
                                   "class='"+categoria+" '"+
                                   "name=subcategoria[] "+
                                   "value='"+subCategorias[i]+"'/>"+
                                   "<span>"+subCategorias[i]+"</span></label>"+
                               "</li>";

                $this.parent().find('.subcategorias ul').append(checkBoxHTML);
                $this.parent().find('.subcategorias').fadeIn();
            });

            $('.categoria').each(function(){
                var val = $(this).val().camelCase(),
                    $this = $(this);
                deshabilitar = categorias[val].deshabilitar;
                $.each(deshabilitar, function(j){
                    $('.categoria').not($this).each(function(i){
                        $(this).find('option[value="'+deshabilitar[j]+'"]').attr('disabled', 'disabled').addClass(val);
                    }); 
                });
            });
            
            //Seteamos el valor previo correspondiente al ID del dropdown que cambiamos
            selected[$this.attr('id')] = $this.val();
        });

        $('.jornada-doble').click(function(){
            if($(this).is(':checked')){
                $(this).parent().parent().parent().find('.horario-pm').fadeIn();
                $('table').find('th.horario-pm').fadeIn();
            }else{
                $(this).parent().parent().parent().find('.horario-pm').fadeOut();
                $('table').find('th.horario-pm').fadeOut();
            }
        });

        $('.habilitar-horario').click(function(){
            if($(this).is(':checked')){
                $(this).parent().next('li').fadeIn().css('display', 'block');
            }else{
                $(this).parent().next('li').fadeOut();
            }
        });


        //Validacion Subcategorias
        $('.subcategorias').change(function(e){
            $subcat = $(this).parent().find('.subcategoria');
            if($subcat.find(':checked').length == 3){
                $subcat.find(':not(:checked)').attr('disabled', 'disabled');
            }else if($subcat.find(':checked').length < 3){
                $subcat.find(':not(:checked)').removeAttr('disabled', 'disabled');
            }
        });


        $('.ciudad').change(function(){
            actualizarComunas();
        });

        $('form').submit(function(e){
            errores = '';
            $('.errors').remove();
            $.each($('.required:not(:hidden)'), function(){
                if(($(this).val() == $(this).attr('placeholder') || $(this).val() == '') || ($(this).val() == 'elige')){
                    errores += "<p>"+$(this).attr('title')+"</p>";
                    $(this).addClass('input-error');
                    if($(this).hasClass('calle')){
                        $(this).next('input').after('<small class="errors">'+$(this).attr('title')+'</small>');
                    }else{
                       $(this).after('<small class="errors">'+$(this).attr('title')+'</small>'); 
                    }
                    
                }else{
                    $(this).removeClass('input-error');
                }
            });

            if( !($('input[name="form[numero]"]').val().match(/(\d+|s\/n)/g)) ){
                errores += "<p>Ingrese solo numeros o s/n en el numero del Lugar</p>";
                $('input[name="form[numero]"]').addClass('input-error');
                $('input[name="form[numero]"]').after('<small class="errors">Ingrese solo numeros o s/n en el numero del Lugar</small>')
            }

            $.each($('.categoria:not(:hidden)'), function(){
                $this = $(this);
                if($this.parent().find('.subcategorias ul').children().length > 0){
                    if($this.parent().find('.subcategorias').find('ul > li').length > 0 && $this.parent().find('.subcategorias').find('ul > li > label').children(':checked').length == 0){
                        $this.addClass('input-error');
                        $this.parent().find('.subcategorias ul').after('<small class="errors">Something something</small>');
                        errores += "<p>Seleccione al menos una Subcategoria por Categoria</p>";
                    }
                }
            });

            $('#form-errors').html(errores);

            if(errores != ''){
                $('body').animate({'scrollTop': 0}, 400);
                $('#form-errors').fadeIn();
            }else{
                $(this).submit();
            }

            return false;
        });
    </script>
{% endblock %}

{% block content %}
<form action="{{ path('_agregar') }}" method="post" {{ form_enctype(form) }}>
{{ form_errors(form) }}

{% if errors %}
    <div class="errores">
        {% for error in errors %}
            <p>{{ error }}</p>
        {% endfor %}
    </div>
{% endif %}

<div id="form-errors"></div>
<ul class="agregar-lugar">
    <li>
        <label>Nombre</label>
        <input type="text" title="Ingresa el Nombre del Lugar" class="required" minlength="2" name="form[nombre]" id="form_nombre" placeholder="Ej. Bar El Tufo"/>
    </li>
    <li>
        <label>Categorias</label>
        {{ data.categoriaSelect | raw}}
        <div class='subcategorias'>
            <ul></ul>
        </div>
    </li>
    <li class="no-default">
        <label>Categorias</label>
        {{ data.categoriaSelect | raw}}
        <span class="quitar-info"><a class="quitar" rel="categoria" href="">Quitar</a></span>
        <div class='subcategorias'><ul></ul></div>
    </li>
    <li class="no-default">
        <label>Categorias</label>
        {{ data.categoriaSelect | raw}}
        <span class="quitar-info"><a class="quitar" rel="categoria" href="">Quitar</a></span>
        <div class='subcategorias'><ul></ul></div>
    </li>
    <li>
        <span class="display-more"><a class="display-more-info" rel="categoria" href="">Otra categoria (Max <span>2</span>)</a></span>
    </li>
    <li>
        <label>Ciudad</label>
        {{ data.ciudadSelect | raw}}
    </li>
    <li>
        <label>Comuna</label>
        {{ data.comunaSelect | raw}}
    </li>
    <li>
        <label>Direccion</label>
        <input type="text" name="form[calle]" title="Ingresa la Calle del Lugar" class="calle required" id="form_calle" placeholder="Ej. Tarapallá"/>
        <input type="text" name="form[numero]" class="numero required" title="Ingresa el Numero del Lugar" id="form_numero" placeholder="1949 o s/n"/>
    </li>
    <li>
         <span class="display-more"><a class="display-next-li" href="">Es parte de una galeria o centro comercial?</a></span>
    </li>
    <li class="no-default">
        <label>Detalle</label>
        <input type="text" name="form[detalle]" id="form_detalle" placeholder="Ej. Local 21, Mall Parque Arauco"/>
        <span class="quitar-info"><a class="quitar" href="">Quitar</a></span>
    </li>
    <li>
        <label>Sector</label>
        {{ data.sectorSelect | raw }}
    </li>
    <li>
        <label>Telefono</label>
        <input type="text" name="form[telefono1]" id="form_telefono1" class="telefono" placeholder="Ej. +56 2 2130894"/>
    </li>
    <li class="no-default">
        <label>Telefono</label>
        <input type="text" name="form[telefono2]" id="form_telefono2" class="telefono" placeholder="Ej. +56 2 2130894"/>
        <span class="quitar-info"><a class="quitar" rel="telefono" href="">Quitar</a></span>
    </li>
    <li class="no-default">
        <label>Telefono</label>
        <input type="text" name="form[telefono3]" id="form_telefono3" class="telefono" placeholder="Ej. +56 2 2130894"/>
        <span class="quitar-info"><a class="quitar" rel="telefono" href="">Quitar</a></span>
    </li>
    <li>
         <span class="display-more"><a class="display-more-info" rel="telefono" href="">Mas telefonos (Max <span>2</span>)</a></span>
    </li>
    <li>
        <label>Sitio Web</label>
        <input type="text" name="form[sitio_web]" id="form_sitio_web" placeholder="Ej. http://www.bareltufo.cl"/>
    </li>
    <li>
        <label>Facebook</label>
        <input type="text" name="form[facebook]" id="form_facebook" placeholder="Ej. http://www.facebook.com/pages/bareltufo"/>
    </li>
    <li>
        <label>Twitter</label>
        <input type="text" name="form[twitter]" id="form_twitter" placeholder="Ej. http://www.twitter.com/barelfuto"/>
    </li>
    <li>
        <label>Mail</label>
        <input type="text" name="form[mail]" id="form_mail" placeholder="Ej. usuario@logoares.com"/>
    </li>
    <li>
        <label>Sabes los horarios de atencion?</label>
        <input type="checkbox" name="habilitar-horario" class="habilitar-horario"/>
    </li>
   <li class="no-default">
        <table class="agregar-horarios">
            <thead>
                <th></th>
                <th>AM Abre</th>
                <th>AM Cierre</th>
                <th class="horario-pm">PM Abre</th>
                <th class="horario-pm">PM Cierre</th>
                <th></th>
            </thead>
            <tbody>
                <tr>
                    <td>Lunes</td>
                    <td>
                        <select name="horario-lunes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-lunes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-lunes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-lunes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td> 
                </tr>
                <tr>
                    <td>Martes</td>
                    <td>
                        <select name="horario-martes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-martes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-martes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-martes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
                    <td>Miercoles</td>
                    <td>
                        <select name="horario-miercoles[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-miercoles[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-miercoles[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-miercoles[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
                    <td>Jueves</td>
                    <td>
                        <select name="horario-jueves[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-jueves[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-jueves[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-jueves[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
                    <td>Viernes</td>
                    <td>
                        <select name="horario-viernes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-viernes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-viernes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-viernes[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
                    <td>Sabado</td>
                    <td>
                        <select name="horario-sabado[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-sabado[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-sabado[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-sabado[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
                    <td>Domingo</td>
                    <td>
                        <select name="horario-domingo[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td>
                        <select name="horario-domingo[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-domingo[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td class="horario-pm">
                        <select name="horario-domingo[]">
                            {{ data.horarios | raw}}
                        </select>
                    </td>
                    <td><label><input type="checkbox" class="jornada-doble"> Jornada doble?</label></td>
                </tr>
                <tr>
            </tbody>
        </table>
        <small>Si no se indica ningún horario para un determinado día, se entenderá que ese día está cerrado.
Si un día se indican los datos de Jornada 1, pero no los de Jornada 2, se entenderá que ese día opera en jornada única.</small>
    </li>
    <li class="no-default">
        <label>Profesional</label>
        <input type="text" name="form[profesional]" id="form_profesional" placeholder="Ej. Nombre del Arquitecto, Paisajista, etc"/>
    </li>
    <li class="no-default">
        <label>Año de Construccion</label>
        <input type="text" name="form[agno_construccion]" id="form_agno_construccion" placeholder="Ej. 1985, Siglo XX"/>
    </li>
    <li class="no-default">
        <label>Descripcion</label>
        <textarea name="form[descripcion]" id="form_descripcion" placeholder="Breve Descripcion Blah Blah"></textarea>
    </li>
    <li class="no-default">
        <label>Materiales</label>
        <input type="text" name="form[materiales]" id="form_materiales" placeholder="Ej. Cobre, Granito, etc"/>
    </li>
    <li class="no-default">
        <label>Caracteristicas</label>
        <div class="caracteristicas"><ul>
        </ul>
        </div>
    </li>
</ul>

{{ form_widget(form._token) }}
<input type="submit" value="Guardar Datos" formnovalidate/>
</form>
{% endblock %}