{% extends "::base_reporte.html.twig" %}

{% block title %}{{'reporte_local.title'|trans}} {{concurso.post.lugar.nombre}} | {{parent()}}{% endblock %}

{% block content %}

	<img class="logo_reporte" src="{{ asset('assets/images/reporte/logo_reporte.png') }}" height="52" width="161" />

	<div class="reporte_local">
		<div class="datos_reporte">
			<h1 class="titulo_reporte">{{'reporte_local.titulo'|trans}} {{concurso.post.lugar.nombre}}</h1> <span class="titulo_reporte">- <a href="{{path('post', {'ciudad' : concurso.post.ciudad.slug, 'slug' : concurso.post.slug})}}">{{'reporte_local.link_nota'|trans}}</a></span><br />

			<div class="datos">
				<p><strong>{{'reporte_local.titulo_fecha'|trans}}</strong></p>
				<p>{{concurso.fechaInicio | date('d/m/Y')}} - {{concurso.fechaTermino | date('d/m/Y')}}</p><br />

				<p><strong>{{'reporte_local.titulo_be'|trans}}</strong></p>
				<p>{{concurso.descripcion}}</p><br />

				<p><strong>{{'reporte_local.titulo_condiciones'|trans}}</strong></p>
				<p>{{concurso.post.condiciones | raw}}</p>
			</div>
		</div>

		<div class="participantes_reporte">
			{% if concurso.participantesActivos | length > 0 %}
				{% set doce = 0 %}
				{% for participante in concurso.participantesActivos %}
					{% if loop.index == 1 or (loop.index > 19 and (loop.index - 1) % 19 == 0)  %}
						{% set doce = 0 %}
						<ul class="listado_participantes">
					{% endif %}
					<li>
						<a href="{{path('showUsuario', {'param' : participante.usuario.slug})}}">
							<img src="{{ ('assets/images/usuarios/'~participante.usuario.imagenFull) | apply_filter('tiny_usuario') }}" width="20" height="20" />
						</a>
					</li>
					{% set doce = doce + 1 %}
					{% if doce == 19 %}
						</ul>				
					{% endif %}
				{% endfor %}
			{% endif %}				

			<div class="participantes">
				<div class="cantidad_participantes_izq">
				</div>							
				<div class="cantidad_participantes">
					<span class="numero_participantes">{{concurso.participantesActivos | length}}</span>
					{{'extra.modulo_concursos.participantes'|transchoice(concurso.participantesActivos | length)}}
				</div>
				<div class="cantidad_participantes_der">
				</div>	
			</div>
		</div>

		<div class="metricas_reporte">
			<p><span class="azul">{{concurso.visitasHome + concurso.visitasBusquedas + concurso.visitasOtrosLocales}}</span> - {{'reporte_local.visitas_home'|trans}}</p>
			<p><span class="azul">{{concurso.visitasPost + 0}}</span> - {{'reporte_local.visitas_totales'|trans}} <a href="{{path('post', {'ciudad' : concurso.post.ciudad.slug, 'slug' : concurso.post.slug})}}">{{'reporte_local.nota'|trans}}</a></p>
			<p><span class="azul">{{concurso.visitasFicha + 0}}</span> - {{'reporte_local.visitas_totales'|trans}} <a href="{{path('_lugar', {'slug' : concurso.post.lugar.slug})}}">{{'reporte_local.ficha'|trans}}</a></p><br />
			<p><span class="azul">{{concurso.post.lugar.totalRecomendaciones}}</span> - <img class="icono_metricas" src="{{ asset('assets/images/reporte/recomendaciones.png') }}" height="15px" width="17px" /> {{'reporte_local.recomendaciones'|trans}}</p>
			<p><span class="azul">{{concurso.facebookFinal - concurso.facebookInicio}}</span> - <img class="icono_metricas" src="{{ asset('assets/images/reporte/facebook.png') }}" height="16px" width="16px" /> {{'reporte_local.facebook'|trans}}</p>
			<p><span class="azul">{{concurso.twitterFinal - concurso.twitterInicio}}</span> - <img class="icono_metricas" src="{{ asset('assets/images/reporte/twitter.png') }}" height="16px" width="16px" /> {{'reporte_local.twitter'|trans}}</p>
		</div>

		{% if concurso.ganadores | length > 0 %}
			<div class="ganadores_reporte">
				<p><strong>{{'reporte_local.ganadores'|trans}}</strong></p><br />
				<p>{{'reporte_local.ganadores_detalle'|trans}}<br />
				{{'reporte_local.ganadores_tip'|trans}} <strong>{{'reporte_local.ganadores_canjeada'|trans}}</strong>.</p><br />

				<ul>
					{% for ganador in concurso.ganadores %}
						<li>
							<input type="checkbox" class="canjes_checkbox" data-ganador="{{ganador.id}}" {% if ganador.canjeado%}disabled="disabled" checked="checked"{% endif %}/>
							<a href="{{path('showUsuario', {'param' : ganador.participante.usuario.slug})}}">
								<img class="imagen_ganador" src="{{ ('assets/images/usuarios/'~ganador.participante.usuario.imagenFull) | apply_filter('tiny_usuario') }}" width="20" height="20" />
								<span>{{ganador.participante.usuario.nombre}} {{ganador.participante.usuario.apellido}}</span>
							</a>
							<span> - {{'usuario.gift_card.codigo'|trans}} <strong>{{ganador.codigo}}</strong></span>
						</li>
					{% endfor %}
				</ul>
				
				<a class="boton_canjeada"></a>
			</div>
		{% endif %}
	</div>

{% endblock %}

{% block javascripts %}
	<script type="text/javascript">
		$(function(){
			$('.boton_canjeada').click(function(){
				if(confirm('¿Estás seguro de marcar los cupones como canjeados? Sólo se pueden asignar una sola vez')) {
					var canjesCheckbox = $('.canjes_checkbox').filter(':checked').filter(':not(:disabled)');
					if(canjesCheckbox.length > 0) {
						var canjes = new Array();
						canjesCheckbox.each(function(){
							canjes.push($(this).attr('data-ganador'));
						});

						$.ajax({
				            url: WEBROOT+'../ajax/cupones_canjeados',
				            type: 'post',
				            data: {'canjes' : canjes},
				            dataType: 'json',
				            success: function(data){
				            	if(data.status == 'ok') {
				            		canjesCheckbox.attr('disabled', 'disabled');
				            	}
				            }
	        			});
					}
					else{
						alert('No has seleccionado cupones para marcarlos como canjeados');
					}
				}
				else {
		    		return false;
		    	}	
			});
		});
	</script>	
{% endblock %}